<!doctype html>

<html>

<head>
  <title>chrome-tabs test</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../chai/chai.js"></script>

  <link rel="import" href="../chrome-tabs.html">
  <link rel="import" href="../chrome-tab.html">
  <link rel="import" href="../../iron-test-helpers/iron-test-helpers.html">
</head>

<body>

  <test-fixture id="basic">
    <template>
        <chrome-tabs extendable></chrome-tabs>
      </template>
  </test-fixture>

  <test-fixture id="multitabs">
    <template>
        <chrome-tabs extendable>
          <chrome-tab unclosable icon="https://www.polymer-project.org/images/logos/p-logo-32.png" title="Tab title"></chrome-tab>
          <chrome-tab icon="https://assets-cdn.github.com/favicon.ico" title="Tab title"></chrome-tab>
          <chrome-tab
                icon='https://www.google.fr/images/branding/product/ico/googleg_lodp.ico'
                title="Google"></chrome-tab>
          <chrome-tab title="Tab title"></chrome-tab>
        </chrome-tabs>
      </template>
  </test-fixture>

  <script>
    suite('chrome-tabs', () => {
      test('instantiating the element works', done => {
        const element = fixture('basic')
        flush(() => {
          assert.equal(element.constructor.name, 'ChromeTabs')
          expect(element.extendable).to.be.equal(true)
          expect(element.selected).to.be.equal(null)
          expect(element.items.length).to.be.equal(0)
          done()
        })
      })

      test('add a tab', (done) => {
        const element = fixture('basic')
        const newTab = document.createElement('chrome-tab')
        newTab.icon = 'zeDesk.png'
        newTab.title = ''
        Polymer.dom(element).appendChild(newTab)

        flush(() => {
          expect(element.items.length).to.be.equal(1)
          expect(element.selected).to.be.equal(0)
          done()
        })
      })

      test('add-tab event', (done) => {
        const element = fixture('basic')
        element.addEventListener('tab-add', evt => {
          expect(evt.type).to.be.equal('tab-add')
          done()
        })
        const shadowRoot = element.shadowRoot
        MockInteractions.tap(shadowRoot.querySelector('.tab-add'))
      })

      test('select by click', (done) => {
        const element = fixture('multitabs')
        flush(() => {
          expect(element.selected).to.be.equal(null)
          expect(element.items.length).to.be.equal(4)
          expect(element.getAttribute('selected')).to.be.equal(null)
          MockInteractions.tap(element.items[2])

          flush(() => {
            expect(element.selected).to.be.equal(2)
            expect(element.getAttribute('selected')).to.be.equal('2')
            done()
          })
        })
      })

      test('select by setting selected', (done) => {
        const element = fixture('multitabs')
        element.selected = 1
        flush(() => {
          expect(element.selectedItem).to.be.eql(element.items[1])
          done()
        })
      })

      test('select by setting the selected attribute', (done) => {
        const element = fixture('multitabs')
        element.setAttribute('selected', '1')
        flush(() => {
          expect(element.selected).to.be.equal(1)
          expect(element.selectedItem).to.be.eql(element.items[1])
          done()
        })
      })

      test('check selected-changed event', (done) => {
        const element = fixture('multitabs')

        var selectEventHandler = sinon.spy()
        element.addEventListener('selected-changed', selectEventHandler)

        element.addEventListener('selected-changed')
        element.setAttribute('selected', '1')
        flush(() => {
          expect(element.selected).to.be.equal(1)
          expect(element.selectedItem).to.be.eql(element.items[1])
          done()
        })
      })

      test('tab-remove event is emitted by clicking a close button', (done) => {
        const element = fixture('multitabs')
        element.selected = 3

        element.addEventListener('tab-remove', evt => {
          expect(evt.type).to.be.equal('tab-remove')
          expect(evt.detail.index).to.be.equal(3)
          expect(document.querySelector('chrome-tabs').children.length).to.be.equal(3)
          done()
        })
        flush(() => {
          expect(element.children.length).to.be.equal(4)
          const tabShadowRoot = element.items[3].shadowRoot
          MockInteractions.tap(tabShadowRoot.querySelector('.tab-close'))
        })
      })

      test('remove the last tab which is selected', (done) => {
        const element = fixture('multitabs')
        element.selected = 3
        flush(() => {
          expect(element.selected).to.be.equal(3)
          expect(element.selectedItem).to.be.eql(element.items[3])
          Polymer.dom(element).removeChild(element.items[3])
          flush(() => {
            expect(element.selected).to.be.equal(2)
            done()
          })
        })
      })

      test('remove a tab which index is greater than the selected one', (done) => {
        const element = fixture('multitabs')
        element.selected = 1
        flush(() => {
          expect(element.selected).to.be.equal(1)
          expect(element.selectedItem).to.be.eql(element.items[1])
          Polymer.dom(element).removeChild(element.items[1])
          flush(() => {
            expect(element.selected).to.be.equal(1)
            expect(element.selectedItem).to.be.eql(element.items[1])
            done()
          })
        })
      })

      test('remove a tab which index is lower than the selected one', (done) => {
        const element = fixture('multitabs')
        element.selected = 1
        flush(() => {
          expect(element.selected).to.be.equal(1)
          expect(element.selectedItem).to.be.eql(element.items[1])
          Polymer.dom(element).removeChild(element.items[0])
          flush(() => {
            expect(element.selected).to.be.equal(0)
            expect(element.selectedItem).to.be.eql(element.items[0])
            done()
          })
        })
      })

      test('remove the selected tab', (done) => {
        const element = fixture('multitabs')
        element.selected = 1
        flush(() => {
          expect(element.selected).to.be.equal(1)
          expect(element.selectedItem).to.be.eql(element.items[1])
          Polymer.dom(element).removeChild(element.items[1])
          flush(() => {
            expect(element.selected).to.be.equal(1)
            expect(element.selectedItem).to.be.eql(element.items[1])
            done()
          })
        })
      })
    })
  </script>
</body>

</html>
